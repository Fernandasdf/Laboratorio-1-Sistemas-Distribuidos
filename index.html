<!-- sistemas distribuidos -->
<!DOCTYPE html>
<html>
	<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ruleta Chat ~ Sistemas Distribuidos</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

		<style type="text/css">
			#camara{
				position: absolute;
			  bottom:10px;
			  left: 12px;
			  display: none;
			}
			#camara_partner{
				top: 10px;
				left: 12px;
				display: none;
			}
			#chatWrap{
				float: right;
				display: none;
			}
			#nickWrap{
				float: right;
			}
		</style>

	</head>
	<body style="background:#ECF8FF">

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>

		<div id="nickWrap">
			<p>Ingrese su nombre de usuario:</p>
			<!-- Y si el nick ya esta siendo usado -->
			<p id="nickError"></p>
			<!-- Recibimos el nick -->
			<form id="setNick">
				<input size="35" id="nickname" placeholder="Ingresa aquí tu nickname"></input>
				<input type="submit" class="btn btn-primary btn-sm"></input>
			</form>
		</div>
		<div id="camara">
		<h3>Tu cam</h3>
		</div>
		<div id="camara_parter">
		<h3>Compañero</h3>
			
		</div>
		<div id = "chatWrap">
			<div id = "users"></div>
			<div id = "chatLog">
				<div id = "chat"></div>
			</div>
			<div id = "chatSend">
				<!-- Formulario para el envio de mensajes -->
				<form id = "send-message">
				<input size="35" id="message"></input>
				<input type="submit"></input>
			</form>
			</div>
		</div>

		<div id = "cuadrito">
			
		</div>

		<script src="http://code.jquery.com/jquery-latest.min.js"></script>
		<!-- Se debe llamar al modulo de socket.io -->
		<script src="/socket.io/socket.io.js"></script>	

		<script>
			/*
			Esta funcion se ejecutara cuando toda la pagina termine de cargar, es automatico
			*/
			$(function(){
				//variable para conectarse al socket
				var socket = io.connect();
				//form para enviar el nick
				var $nickForm = $('#setNick');
				//por si hay nick repetido
				var $nickError = $('#nickError');
				//el nick en si
				var $nickBox = $('#nickname');
				//usuarios
				var $users = $('#users');
				//form para enviar el mensaje 
				var $messageForm = $('#send-message');
				//este es el input, el mensaje en si
				var $messageBox = $('#message');
				//chat, es la variable donde se irá mostrando el chat
				var $chat = $('#chat');

				//cada vez que se haga un submit de un nick, lo enviaremos al servidor
				$nickForm.submit(function(e){
					//Para evitar que se hagan refresh de la página, así solo enviamos el mensaje
					e.preventDefault();
					/*
						hacemos un emit bajo el alias new user, aca hacemos algo distinto
						si el nick es valido, escondemos la parte de ingreso de nick y 
						mostramos la ventana del chat
						OJO! Es la misma vista!
					*/
					socket.emit('new user', $nickBox.val(), function(data){
						//Si se retorna true (este es el valor de callback desde el servidor) ingresamos al chat
						if(data){
							$('#nickWrap').hide();
							$('#chatWrap').show();
							$('#camara').show();
							$('#camara_partner').show();
						}
						//Si no, mostramos mensaje de error al usuario
						else{
							$nickError.html('Nombre de usuario ya existe, intenta con otro.');
						}
					});
					//Vaciamos el contenido de nickbox
					$nickBox.val('');
				});

				/*
					Aca es donde mostramos los usuarios conectados
					simplemente iteramos por el arreglo de usuarios
				*/
				socket.on('usernames', function(data){
					var html = '';
					for(i=0; i<data.length; i++){
						html += data[i]+'<br/>'
					}
					$users.html(html);

				});

				// cada vez que se haga un submit de un mensaje, lo enviaremos al servidor
				$messageForm.submit(function(e){
					//Para evitar que se hagan refresh de la página, así solo enviamos el mensaje
					e.preventDefault();
					/*Hacemos un emit por medio nuestro socket, envia un evento al servidor
					  en este caso se llama 'send message'
					  y envia el contenido de messageBox
					*/
					socket.emit('send message', $messageBox.val());
					//limpiamos el contenido
					$messageBox.val('');
				});

				/*
					recibimos el mensaje del servidor, estamos usando el mismo alias 
					que el nos envio: 'new message'
				*/
				socket.on('new message', function(data){
					/*	hacemos un append para no perder los mensajes anteriores
						y mostramos el nick y el mensaje
					*/
					$chat.append('<b>'+data.nick+':</b>'+data.msg+"<br/>");
				});

			});
		</script>
		<script src='http://static.opentok.com/webrtc/v2.2/js/opentok.min.js'></script>
		<script type="text/javascript">
		  // Initialize API key, session, and token...
		  // Think of a session as a room, and a token as the key to get in to the room
		  // Sessions and tokens are generated on your server and passed down to the client
		  var apiKey = "45012012";
		  var sessionId = "1_MX40NTAxMjAxMn5-MTQxMjU0MTEyMjExM35hSmhjU29Id0k0SjVyK1ZuVllid0xlUjN-fg";
		  var token = "T1==cGFydG5lcl9pZD00NTAxMjAxMiZzaWc9OWJkMTY1ZTBlZjEwM2M1N2MyNGJkZWM1ODdmNTM0Yzg2ZTU0MjQ3YTpyb2xlPXB1Ymxpc2hlciZzZXNzaW9uX2lkPTFfTVg0ME5UQXhNakF4TW41LU1UUXhNalUwTVRFeU1qRXhNMzVoU21oalUyOUlkMGswU2pWeUsxWnVWbGxpZDB4bFVqTi1mZyZjcmVhdGVfdGltZT0xNDEyNTQxMTQxJm5vbmNlPTAuMzg0MDE3NTk5MjE0Nzg4OTUmZXhwaXJlX3RpbWU9MTQxMjU0NDY2NQ==";

		  // Initialize session, set up event listeners, and connect
		  var session = OT.initSession(apiKey, sessionId);
	 
		  session.on("streamCreated", function(event) {
			session.subscribe(event.stream,"camara_parter",{width:400,height:400} );
		  });
		 
		  session.connect(token, function(error) {
			if(error){
				console.log(error.message);
			}else{
				session.publish('camara',{width:260,height:260});
			}
		  });

		
		 
		var token = opentok.generateToken(sessionId);

		// Set the following constants with the API key and API secret
// that you receive when you sign up to use the OpenTok API:
var opentok = new OpenTok(API_KEY, API_SECRET);
 
//Generate a basic session. Or you could use an existing session ID.
var sessionId;
var token
opentok.createSession({}, function(error, session) {
  if (error) {
    console.log("Error creating session:", error)
  } else {
    sessionId = session.sessionId;
    console.log("Session ID: " + sessionId);
    //  Use the role value appropriate for the user:
    var tokenOptions = {};
    tokenOptions.role = "publisher";
    tokenOptions.data = "username=bob";
 
    // Generate a token.
    token = opentok.generateToken(sessionId, tokenOptions);
    console.log(token);
  }
});
		</script>

	</body>
</html>
